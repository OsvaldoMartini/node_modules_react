{"ast":null,"code":"'use strict';\n\nconst fs = require('graceful-fs');\n\nconst path = require('path');\n\nconst copySync = require('../copy-sync').copySync;\n\nconst removeSync = require('../remove').removeSync;\n\nconst mkdirpSync = require('../mkdirs').mkdirsSync;\n\nconst buffer = require('../util/buffer');\n\nfunction moveSync(src, dest, options) {\n  options = options || {};\n  const overwrite = options.overwrite || options.clobber || false;\n  src = path.resolve(src);\n  dest = path.resolve(dest);\n  if (src === dest) return fs.accessSync(src);\n  if (isSrcSubdir(src, dest)) throw new Error(\"Cannot move '\".concat(src, \"' into itself '\").concat(dest, \"'.\"));\n  mkdirpSync(path.dirname(dest));\n  tryRenameSync();\n\n  function tryRenameSync() {\n    if (overwrite) {\n      try {\n        return fs.renameSync(src, dest);\n      } catch (err) {\n        if (err.code === 'ENOTEMPTY' || err.code === 'EEXIST' || err.code === 'EPERM') {\n          removeSync(dest);\n          options.overwrite = false; // just overwriteed it, no need to do it again\n\n          return moveSync(src, dest, options);\n        }\n\n        if (err.code !== 'EXDEV') throw err;\n        return moveSyncAcrossDevice(src, dest, overwrite);\n      }\n    } else {\n      try {\n        fs.linkSync(src, dest);\n        return fs.unlinkSync(src);\n      } catch (err) {\n        if (err.code === 'EXDEV' || err.code === 'EISDIR' || err.code === 'EPERM' || err.code === 'ENOTSUP') {\n          return moveSyncAcrossDevice(src, dest, overwrite);\n        }\n\n        throw err;\n      }\n    }\n  }\n}\n\nfunction moveSyncAcrossDevice(src, dest, overwrite) {\n  const stat = fs.statSync(src);\n\n  if (stat.isDirectory()) {\n    return moveDirSyncAcrossDevice(src, dest, overwrite);\n  } else {\n    return moveFileSyncAcrossDevice(src, dest, overwrite);\n  }\n}\n\nfunction moveFileSyncAcrossDevice(src, dest, overwrite) {\n  const BUF_LENGTH = 64 * 1024;\n\n  const _buff = buffer(BUF_LENGTH);\n\n  const flags = overwrite ? 'w' : 'wx';\n  const fdr = fs.openSync(src, 'r');\n  const stat = fs.fstatSync(fdr);\n  const fdw = fs.openSync(dest, flags, stat.mode);\n  let bytesRead = 1;\n  let pos = 0;\n\n  while (bytesRead > 0) {\n    bytesRead = fs.readSync(fdr, _buff, 0, BUF_LENGTH, pos);\n    fs.writeSync(fdw, _buff, 0, bytesRead);\n    pos += bytesRead;\n  }\n\n  fs.closeSync(fdr);\n  fs.closeSync(fdw);\n  return fs.unlinkSync(src);\n}\n\nfunction moveDirSyncAcrossDevice(src, dest, overwrite) {\n  const options = {\n    overwrite: false\n  };\n\n  if (overwrite) {\n    removeSync(dest);\n    tryCopySync();\n  } else {\n    tryCopySync();\n  }\n\n  function tryCopySync() {\n    copySync(src, dest, options);\n    return removeSync(src);\n  }\n} // return true if dest is a subdir of src, otherwise false.\n// extract dest base dir and check if that is the same as src basename\n\n\nfunction isSrcSubdir(src, dest) {\n  try {\n    return fs.statSync(src).isDirectory() && src !== dest && dest.indexOf(src) > -1 && dest.split(path.dirname(src) + path.sep)[1].split(path.sep)[0] === path.basename(src);\n  } catch (e) {\n    return false;\n  }\n}\n\nmodule.exports = {\n  moveSync\n};","map":null,"metadata":{},"sourceType":"script"}